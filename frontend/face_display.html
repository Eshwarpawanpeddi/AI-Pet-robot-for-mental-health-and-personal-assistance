<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pet Robot Control - Enhanced Edition</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .main-container {
            display: flex;
            height: 100vh;
            background: #000;
        }
        
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            width: 400px;
            background: #1a1a1a;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #333;
        }
        
        .camera-view {
            width: 100%;
            height: 300px;
            background: #000;
            border: 2px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .camera-view img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 6px;
        }
        
        .camera-placeholder {
            color: #666;
            font-size: 14px;
        }
        
        .audio-controls {
            margin-top: 20px;
        }
        
        .audio-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .audio-btn.listening {
            background: #ef4444;
            color: white;
        }
        
        .audio-btn.idle {
            background: #10b981;
            color: white;
        }
        
        .audio-btn:hover {
            opacity: 0.8;
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #333;
            color: white;
        }
        
        .mode-btn.active {
            background: #667eea;
        }
        
        .section-title {
            color: #fff;
            font-size: 18px;
            margin: 20px 0 10px 0;
            font-weight: bold;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .connection-status.connected {
            background: #10b981;
            color: white;
        }
        
        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .voice-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .voice-control-group {
            margin-bottom: 15px;
        }
        
        .voice-control-group label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .voice-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
        }
        
        .voice-slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .slider-value {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }
        
        .tts-input-group {
            margin-top: 15px;
        }
        
        .tts-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 6px;
            background: #2a2a2a;
            color: white;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        
        .tts-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tts-btn:hover {
            background: #5568d3;
        }
        
        .tts-btn:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-panel">
            <div class="robot-container">
                <canvas id="faceCanvas" class="face-canvas"></canvas>
                
                <div class="status-bar">
                    <div class="status-item">User Feel: <span id="userEmotion" style="color:#4ade80">Neutral</span></div>
                    <div class="status-item">Robot Feel: <span id="robotEmotion" style="color:#fbbf24">Neutral</span></div>
                    <div class="status-item">Battery: <span id="batteryLevel">100</span>%</div>
                    <div class="status-item">Mode: <span id="controlMode">Manual</span></div>
                </div>

                <div class="control-panel">
                    <button class="btn" onclick="sendText('How are you?')">üëã Say Hello</button>
                    <button class="btn" onclick="changeEmotion('happy')">üòä Happy</button>
                    <button class="btn" onclick="changeEmotion('sad')">üò¢ Sad (Cry)</button>
                    <button class="btn" onclick="changeEmotion('angry')">üí¢ Angry</button>
                    <button class="btn" onclick="changeEmotion('neutral')">üòê Neutral</button>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="connection-status" id="connectionStatus">Connecting...</div>
            
            <div class="section-title">üìπ Camera View</div>
            <div class="camera-view" id="cameraView">
                <div class="camera-placeholder">Camera Off</div>
            </div>
            <button class="audio-btn idle" id="cameraBtn" onclick="toggleCamera()">Start Camera</button>
            
            <div class="section-title">üé§ Audio Controls</div>
            <button class="audio-btn idle" id="listenBtn" onclick="toggleListening()">üé§ Start Listening</button>
            <button class="audio-btn idle" id="speakBtn" onclick="toggleSpeaking()">üîä Robot Speak</button>
            
            <div class="section-title">üéôÔ∏è Voice & TTS Controls</div>
            <div class="voice-controls">
                <div class="voice-control-group">
                    <label for="voiceSelect">Voice:</label>
                    <select id="voiceSelect" class="voice-select" onchange="updateVoiceSettings()">
                        <option value="en">English Male (Default)</option>
                        <option value="en+f1">English Female 1</option>
                        <option value="en+f2">English Female 2</option>
                        <option value="en+f3" selected>English Female 3 (Recommended)</option>
                        <option value="en+f4">English Female 4</option>
                        <option value="en+m1">English Male 1</option>
                        <option value="en+m2">English Male 2</option>
                        <option value="en+m3">English Male 3</option>
                        <option value="en+m4">English Male 4 (Deep)</option>
                        <option value="en+m7">English Male 7 (Very Deep)</option>
                        <option value="en-us">American English</option>
                        <option value="en-uk">British English</option>
                        <option value="en-scottish">Scottish English</option>
                    </select>
                </div>
                
                <div class="voice-control-group">
                    <label for="speedSlider">Speed: <span id="speedValue" class="slider-value">150</span> wpm</label>
                    <input type="range" id="speedSlider" class="voice-slider" min="80" max="450" value="150" oninput="updateSpeedDisplay()">
                </div>
                
                <div class="voice-control-group">
                    <label for="pitchSlider">Pitch: <span id="pitchValue" class="slider-value">50</span></label>
                    <input type="range" id="pitchSlider" class="voice-slider" min="0" max="99" value="50" oninput="updatePitchDisplay()">
                </div>
                
                <div class="tts-input-group">
                    <textarea id="ttsInput" class="tts-input" placeholder="Type text to speak..."></textarea>
                    <button class="tts-btn" onclick="sendTTS()">üîä Speak & Broadcast</button>
                </div>
            </div>
            
            <div class="section-title">üéÆ Control Mode</div>
            <div class="mode-toggle">
                <button class="mode-btn active" id="manualBtn" onclick="setMode('manual')">Manual</button>
                <button class="mode-btn" id="rosBtn" onclick="setMode('autonomous')">ROS/Auto</button>
            </div>
        </div>
    </div>

    <script>
        class ExpressiveEyesRenderer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.emotion = 'neutral';
                this.eyeOpen = 1.0;
                this.time = 0;
                this.tears = [];
                this.angerShake = 0;
                this.angerIntensity = 0;
                
                // Initialize sizing
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                this.animate();
            }

            resize() {
                // Adjusts the internal drawing resolution to match the screen
                this.canvas.width = this.canvas.clientWidth;
                this.canvas.height = this.canvas.clientHeight;
                this.centerX = this.canvas.width / 2;
                this.centerY = this.canvas.height / 2;
            }

            animate() {
                this.time += 0.05;
                this.eyeOpen = (this.time % 5 < 0.15) ? 0.1 : 1.0;
                
                // Animate anger shake
                if (this.emotion === 'angry') {
                    this.angerShake = Math.sin(this.time * 3) * 5;
                    this.angerIntensity = Math.abs(Math.sin(this.time * 2)) * 0.5 + 0.5;
                }
                
                this.draw();
                requestAnimationFrame(() => this.animate());
            }

            draw() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                const color = this.getEmotionColor();
                
                if (this.emotion === 'sad') {
                    this.drawTears();
                }
                
                if (this.emotion === 'angry') {
                    this.drawAngerEffects();
                }

                // Spacing between eyes scales with screen width
                const eyeSpacing = this.canvas.width * 0.16;
                const shakeX = this.emotion === 'angry' ? this.angerShake : 0;
                this.drawEye(this.centerX - eyeSpacing + shakeX, this.centerY, color, 'L');
                this.drawEye(this.centerX + eyeSpacing + shakeX, this.centerY, color, 'R');
            }
            
            drawAngerEffects() {
                // Add pulsing red background effect
                const alpha = this.angerIntensity * 0.2;
                this.ctx.fillStyle = `rgba(255, 80, 80, ${alpha})`;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Add anger lines/sparks
                this.ctx.strokeStyle = `rgba(255, 100, 100, ${this.angerIntensity})`;
                this.ctx.lineWidth = 3;
                for (let i = 0; i < 3; i++) {
                    const angle = (this.time * 2 + i * Math.PI * 2 / 3) % (Math.PI * 2);
                    const x = this.centerX + Math.cos(angle) * 150;
                    const y = this.centerY + Math.sin(angle) * 100;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, y);
                    this.ctx.lineTo(x + Math.cos(angle) * 30, y + Math.sin(angle) * 30);
                    this.ctx.stroke();
                }
            }

            drawTears() {
                const eyeSpacing = this.canvas.width * 0.16;
                if (Math.random() > 0.92) {
                    this.tears.push({x: (this.centerX - eyeSpacing) + (Math.random()*30-15), y: this.centerY + 20, speed: Math.random()*2+2});
                    this.tears.push({x: (this.centerX + eyeSpacing) + (Math.random()*30-15), y: this.centerY + 20, speed: Math.random()*2+2});
                }

                this.ctx.fillStyle = 'rgba(74, 144, 226, 0.7)';
                for (let i = 0; i < this.tears.length; i++) {
                    let t = this.tears[i];
                    t.y += t.speed;
                    this.ctx.beginPath();
                    this.ctx.arc(t.x, t.y, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    if (t.y > this.canvas.height) {
                        this.tears.splice(i, 1);
                        i--;
                    }
                }
            }

            drawEye(x, y, color, side) {
                this.ctx.save();
                this.ctx.translate(x, y);
                this.ctx.fillStyle = color;
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = color;

                // Scale the eye size based on screen height
                const baseSize = this.canvas.height * 0.12;

                if (this.emotion === 'happy') {
                    this.ctx.lineWidth = baseSize * 0.25;
                    this.ctx.strokeStyle = color;
                    this.ctx.lineCap = 'round';
                    this.ctx.beginPath();
                    this.ctx.arc(0, baseSize * 0.2, baseSize * 0.6, Math.PI, 0, false);
                    this.ctx.stroke();
                } else if (this.emotion === 'angry') {
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = baseSize * 0.2;
                    this.ctx.lineCap = 'round';
                    this.ctx.beginPath();
                    if (side === 'L') {
                        this.ctx.moveTo(-baseSize, -baseSize);
                        this.ctx.lineTo(baseSize * 0.5, -baseSize * 0.4);
                    } else {
                        this.ctx.moveTo(baseSize, -baseSize);
                        this.ctx.lineTo(-baseSize * 0.5, -baseSize * 0.4);
                    }
                    this.ctx.stroke();
                    this.drawPill(baseSize * 0.9, baseSize * 1.5);
                } else if (this.emotion === 'sad') {
                    this.ctx.rotate(side === 'L' ? -0.25 : 0.25);
                    this.drawPill(baseSize * 0.8, baseSize * 1.1 * this.eyeOpen);
                } else {
                    this.drawPill(baseSize * 0.9, baseSize * 1.5 * this.eyeOpen);
                }
                this.ctx.restore();
            }

            drawPill(w, h) {
                this.ctx.beginPath();
                this.ctx.roundRect(-w/2, -h/2, w, h, w/2);
                this.ctx.fill();
            }

            getEmotionColor() {
                const colors = {
                    'happy': '#FFD700', 'sad': '#4A90E2', 'angry': '#FF5050', 'neutral': '#4ADE80'
                };
                return colors[this.emotion] || colors['neutral'];
            }
        }

        const eyes = new ExpressiveEyesRenderer('faceCanvas');
        
        let cameraActive = false;
        let isListening = false;
        let isSpeaking = false;

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/control`);
        
        ws.onopen = () => {
            document.getElementById('connectionStatus').className = 'connection-status connected';
            document.getElementById('connectionStatus').textContent = '‚úì Connected to Server';
            ws.send(JSON.stringify({ type: 'subscribe_camera' }));
        };
        
        ws.onclose = () => {
            document.getElementById('connectionStatus').className = 'connection-status disconnected';
            document.getElementById('connectionStatus').textContent = '‚úó Disconnected';
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'state') {
                const state = data.data;
                eyes.emotion = state.emotion;
                document.getElementById('userEmotion').textContent = state.user_emotion;
                document.getElementById('robotEmotion').textContent = state.emotion;
                document.getElementById('batteryLevel').textContent = state.battery_level;
                document.getElementById('controlMode').textContent = state.control_mode || 'Manual';
                
                // Update connection status
                if (state.raspberry_pi_connected) {
                    document.getElementById('connectionStatus').className = 'connection-status connected';
                    document.getElementById('connectionStatus').textContent = '‚úì Connected - Pi Online';
                }
            } else if (data.type === 'camera_frame') {
                // Display camera frame
                const cameraView = document.getElementById('cameraView');
                cameraView.innerHTML = `<img src="data:image/jpeg;base64,${data.frame}" alt="Camera Feed">`;
            } else if (data.type === 'tts_output') {
                // Play TTS audio on port 8000
                playTTSAudio(data.text);
            }
        };
        
        // Web Speech API for TTS playback on port 8000
        function playTTSAudio(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Try to match the selected voice (Web Speech API has different voice IDs)
                const voices = window.speechSynthesis.getVoices();
                const voiceSelect = document.getElementById('voiceSelect').value;
                
                // Map espeak voice IDs to Web Speech API voices
                if (voiceSelect.includes('f')) {
                    // Female voice - find a female English voice
                    const femaleVoice = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('female'));
                    if (femaleVoice) utterance.voice = femaleVoice;
                } else if (voiceSelect.includes('m')) {
                    // Male voice - find a male English voice
                    const maleVoice = voices.find(v => v.lang.startsWith('en') && v.name.toLowerCase().includes('male'));
                    if (maleVoice) utterance.voice = maleVoice;
                }
                
                // Set rate and pitch (Web Speech API uses different scales)
                const speed = parseInt(document.getElementById('speedSlider').value);
                const pitch = parseInt(document.getElementById('pitchSlider').value);
                
                utterance.rate = speed / 150; // Normalize to Web Speech API rate (0.1 to 10)
                utterance.pitch = pitch / 50;  // Normalize to Web Speech API pitch (0 to 2)
                
                window.speechSynthesis.speak(utterance);
                console.log(`Playing TTS: "${text}"`);
            } else {
                console.log('Speech synthesis not supported, displaying text:', text);
                // Fallback: display the text
                alert(`Robot says: ${text}`);
            }
        }

        function changeEmotion(emo) {
            eyes.emotion = emo;
            ws.send(JSON.stringify({ type: 'emotion', emotion: emo }));
        }

        function sendText(txt) {
            ws.send(JSON.stringify({ type: 'text', text: txt }));
        }
        
        function updateSpeedDisplay() {
            const value = document.getElementById('speedSlider').value;
            document.getElementById('speedValue').textContent = value;
        }
        
        function updatePitchDisplay() {
            const value = document.getElementById('pitchSlider').value;
            document.getElementById('pitchValue').textContent = value;
        }
        
        async function updateVoiceSettings() {
            const voice = document.getElementById('voiceSelect').value;
            const speed = document.getElementById('speedSlider').value;
            const pitch = document.getElementById('pitchSlider').value;
            
            try {
                const response = await fetch('/api/tts/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice, speed: parseInt(speed), pitch: parseInt(pitch) })
                });
                
                const result = await response.json();
                console.log('Voice settings updated:', result);
            } catch (error) {
                console.error('Failed to update voice settings:', error);
            }
        }
        
        async function sendTTS() {
            const text = document.getElementById('ttsInput').value.trim();
            if (!text) {
                alert('Please enter text to speak');
                return;
            }
            
            const voice = document.getElementById('voiceSelect').value;
            const speed = parseInt(document.getElementById('speedSlider').value);
            const pitch = parseInt(document.getElementById('pitchSlider').value);
            
            try {
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, voice, speed, pitch })
                });
                
                const result = await response.json();
                console.log('TTS broadcast:', result);
                
                // Clear input
                document.getElementById('ttsInput').value = '';
            } catch (error) {
                console.error('Failed to send TTS:', error);
                alert('Failed to send TTS command');
            }
        }
        
        function toggleCamera() {
            cameraActive = !cameraActive;
            const btn = document.getElementById('cameraBtn');
            if (cameraActive) {
                ws.send(JSON.stringify({ type: 'start_camera' }));
                btn.textContent = 'Stop Camera';
                btn.className = 'audio-btn listening';
            } else {
                ws.send(JSON.stringify({ type: 'stop_camera' }));
                btn.textContent = 'Start Camera';
                btn.className = 'audio-btn idle';
                document.getElementById('cameraView').innerHTML = '<div class="camera-placeholder">Camera Off</div>';
            }
        }
        
        function toggleListening() {
            isListening = !isListening;
            const btn = document.getElementById('listenBtn');
            if (isListening) {
                ws.send(JSON.stringify({ type: 'start_listening' }));
                btn.textContent = 'üé§ Listening...';
                btn.className = 'audio-btn listening';
            } else {
                ws.send(JSON.stringify({ type: 'stop_listening' }));
                btn.textContent = 'üé§ Start Listening';
                btn.className = 'audio-btn idle';
            }
        }
        
        function toggleSpeaking() {
            isSpeaking = !isSpeaking;
            const btn = document.getElementById('speakBtn');
            if (isSpeaking) {
                btn.textContent = 'üîä Speaking...';
                btn.className = 'audio-btn listening';
            } else {
                btn.textContent = 'üîä Robot Speak';
                btn.className = 'audio-btn idle';
            }
        }
        
        function setMode(mode) {
            ws.send(JSON.stringify({ type: 'set_mode', mode: mode }));
            
            // Update UI
            document.getElementById('manualBtn').className = mode === 'manual' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('rosBtn').className = mode === 'autonomous' ? 'mode-btn active' : 'mode-btn';
        }
    </script>
</body>
</html>