<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pet Robot Face - Expressive Cute Eyes</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .face-canvas { 
            background: #000; 
            border: 8px solid #222; 
            border-radius: 60px; 
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }
        .robot-container { 
            background: rgba(0,0,0,0.3); 
            padding: 30px; 
            border-radius: 50px;
        }
    </style>
</head>
<body>
    <div class="robot-container">
        <canvas id="faceCanvas" class="face-canvas" width="500" height="400"></canvas>
        
        <div class="status-bar">
            <div class="status-item">User Feel: <span id="userEmotion" style="color:#4ade80">Neutral</span></div>
            <div class="status-item">Robot Feel: <span id="robotEmotion" style="color:#fbbf24">Neutral</span></div>
            <div class="status-item">Battery: <span id="batteryLevel">100</span>%</div>
        </div>

        <div class="control-panel">
            <button class="btn" onclick="sendText('How are you?')">üëã Say Hello</button>
            <button class="btn" onclick="changeEmotion('happy')">üòä Happy</button>
            <button class="btn" onclick="changeEmotion('sad')">üò¢ Sad (Cry)</button>
            <button class="btn" onclick="changeEmotion('angry')">üí¢ Angry</button>
            <button class="btn" onclick="changeEmotion('neutral')">üòê Neutral</button>
        </div>
    </div>

    <script>
        class ExpressiveEyesRenderer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.emotion = 'neutral';
                this.eyeOpen = 1.0;
                this.time = 0;
                this.tears = []; // Array to hold falling tear particles
                this.animate();
            }

            animate() {
                this.time += 0.05;
                // Periodic blinking logic
                this.eyeOpen = (this.time % 5 < 0.15) ? 0.1 : 1.0;
                this.draw();
                requestAnimationFrame(() => this.animate());
            }

            draw() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, 500, 400);
                
                const color = this.getEmotionColor();
                
                // If sad, handle tear animations
                if (this.emotion === 'sad') {
                    this.drawTears();
                }

                // Draw left and right eyes
                this.drawEye(170, 200, color, 'L');
                this.drawEye(330, 200, color, 'R');
            }

            drawTears() {
                // Spawn new tears occasionally
                if (Math.random() > 0.92) {
                    this.tears.push({x: 170 + (Math.random()*30-15), y: 220, speed: Math.random()*2+2});
                    this.tears.push({x: 330 + (Math.random()*30-15), y: 220, speed: Math.random()*2+2});
                }

                this.ctx.fillStyle = 'rgba(74, 144, 226, 0.7)';
                for (let i = 0; i < this.tears.length; i++) {
                    let t = this.tears[i];
                    t.y += t.speed;
                    this.ctx.beginPath();
                    this.ctx.arc(t.x, t.y, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Remove tears that fall off screen
                    if (t.y > 400) {
                        this.tears.splice(i, 1);
                        i--;
                    }
                }
            }

            drawEye(x, y, color, side) {
                this.ctx.save();
                this.ctx.translate(x, y);
                this.ctx.fillStyle = color;
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = color;

                if (this.emotion === 'happy') {
                    // Cute curved "n" shape eyes (^)
                    this.ctx.lineWidth = 15;
                    this.ctx.strokeStyle = color;
                    this.ctx.lineCap = 'round';
                    this.ctx.beginPath();
                    this.ctx.arc(0, 15, 30, Math.PI, 0, false);
                    this.ctx.stroke();
                } else if (this.emotion === 'angry') {
                    // Thick visible slanted eyebrows
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = 14;
                    this.ctx.lineCap = 'round';
                    this.ctx.beginPath();
                    if (side === 'L') {
                        this.ctx.moveTo(-50, -65);
                        this.ctx.lineTo(25, -35);
                    } else {
                        this.ctx.moveTo(50, -65);
                        this.ctx.lineTo(-25, -35);
                    }
                    this.ctx.stroke();
                    this.drawPill(45, 75);
                } else if (this.emotion === 'sad') {
                    // Droopy slanted eyes
                    this.ctx.rotate(side === 'L' ? -0.25 : 0.25);
                    this.drawPill(40, 55 * this.eyeOpen);
                } else {
                    // Neutral pill eyes
                    this.drawPill(48, 75 * this.eyeOpen);
                }
                this.ctx.restore();
            }

            drawPill(w, h) {
                this.ctx.beginPath();
                this.ctx.roundRect(-w/2, -h/2, w, h, 20);
                this.ctx.fill();
            }

            getEmotionColor() {
                const colors = {
                    'happy': '#FFD700', // Gold
                    'sad': '#4A90E2',   // Blue
                    'angry': '#FF5050',  // Red
                    'neutral': '#4ADE80' // Mint Green
                };
                return colors[this.emotion] || colors['neutral'];
            }
        }

        const eyes = new ExpressiveEyesRenderer('faceCanvas');

        // WebSocket Communication
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/control`);

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'state') {
                const state = data.data;
                eyes.emotion = state.emotion;
                document.getElementById('userEmotion').textContent = state.user_emotion;
                document.getElementById('robotEmotion').textContent = state.emotion;
                document.getElementById('batteryLevel').textContent = state.battery_level;
            }
        };

        function changeEmotion(emo) {
            eyes.emotion = emo;
            ws.send(JSON.stringify({ type: 'emotion', emotion: emo }));
        }

        function sendText(txt) {
            ws.send(JSON.stringify({ type: 'text', text: txt }));
        }

        function sendCommand(dir) {
            ws.send(JSON.stringify({ type: 'move', direction: dir, speed: 200 }));
        }
    </script>
</body>
</html>